#!/bin/sh
# Pre-commit hook: runs all checks before allowing commit

echo "Running pre-commit checks..."

# Change to frontend directory (handle being called from repo root)
if [ -d "frontend" ]; then
    cd frontend
fi

# Run all checks
npm run check

# Capture exit code
EXIT_CODE=$?

if [ $EXIT_CODE -ne 0 ]; then
    echo ""
    echo "❌ Pre-commit checks failed. Commit aborted."
    echo "Fix the issues above and try again."
    exit 1
fi

# Check for changes that might affect visual snapshots
check_snapshot_impact() {
    STAGED_FILES=$(git diff --cached --name-only)
    SNAPSHOT_WARNING=""

    # Header affects all page snapshots
    if echo "$STAGED_FILES" | grep -qE "Header\.(tsx|module\.css)"; then
        SNAPSHOT_WARNING="Header changes affect: dashboard, analytics, statistics snapshots"
    fi

    # View-specific components
    if echo "$STAGED_FILES" | grep -qE "views/Dashboard|LeagueStandings|GameweekCountdown|ReleaseNotification"; then
        SNAPSHOT_WARNING="${SNAPSHOT_WARNING:+$SNAPSHOT_WARNING\n}Dashboard component changes may affect: dashboard snapshots"
    fi

    if echo "$STAGED_FILES" | grep -qE "views/Analytics|features/HeadToHead|features/Recommendations"; then
        SNAPSHOT_WARNING="${SNAPSHOT_WARNING:+$SNAPSHOT_WARNING\n}Analytics component changes may affect: analytics, head-to-head snapshots"
    fi

    if echo "$STAGED_FILES" | grep -qE "views/Statistics|features/BenchPoints|features/CaptainSuccess|features/LeaguePosition"; then
        SNAPSHOT_WARNING="${SNAPSHOT_WARNING:+$SNAPSHOT_WARNING\n}Statistics component changes may affect: statistics snapshots"
    fi

    if echo "$STAGED_FILES" | grep -qE "FplUpdating"; then
        SNAPSHOT_WARNING="${SNAPSHOT_WARNING:+$SNAPSHOT_WARNING\n}FplUpdating changes may affect: error-states snapshots"
    fi

    if echo "$STAGED_FILES" | grep -qE "ManagerModal|TeamLineup"; then
        SNAPSHOT_WARNING="${SNAPSHOT_WARNING:+$SNAPSHOT_WARNING\n}ManagerModal changes may affect: manager-modal snapshots"
    fi

    if echo "$STAGED_FILES" | grep -qE "features/PlayerDetails"; then
        SNAPSHOT_WARNING="${SNAPSHOT_WARNING:+$SNAPSHOT_WARNING\n}PlayerDetails changes may affect: player-modal snapshots"
    fi

    # Global styles affect everything
    if echo "$STAGED_FILES" | grep -qE "styles/variables\.css|index\.css"; then
        SNAPSHOT_WARNING="${SNAPSHOT_WARNING:+$SNAPSHOT_WARNING\n}Global style changes may affect ALL visual snapshots"
    fi

    if [ -n "$SNAPSHOT_WARNING" ]; then
        echo ""
        echo "⚠️  SNAPSHOT WARNING:"
        echo "$SNAPSHOT_WARNING" | while read -r line; do
            echo "   • $line"
        done
        echo ""
        echo "   Run 'npm run test:e2e:docker' to verify snapshots before pushing."
        echo "   Update snapshots with 'npm run test:e2e:docker:update' if changes are intentional."
        echo ""
    fi
}

check_snapshot_impact

echo "✅ All checks passed!"
exit 0
